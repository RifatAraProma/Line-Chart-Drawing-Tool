<!DOCTYPE html>
<html>

<head>
  <title>Drawing Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.1.1/svg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    #drawing-container {
      border: 1px solid black;
      width: 1000px;
      height: 375px;
    }
  </style>
</head>

<body>
  <div id="drawing-container"></div>
  <button id="saveButton" onclick="saveData()" disabled>Save Data</button>
  <div id="chart"></div>

  <script>
    // Create an SVG.js instance and attach it to the drawing container
    const drawing = SVG().addTo('#drawing-container').size(1000, 375).id('chartSvg');

    // Array to store the coordinates of the drawn lines
    let drawingData = [];
    let dataToSave = [];

    // Flag to track when the user is drawing
    let isDrawing = false;

    // Event handler for mouse down and touch start
    const startDrawing = (event) => {
      event.preventDefault(); // Prevent default scrolling behavior
      isDrawing = true;
      const { x, y } = getCoordinates(event);
      drawingData.push([x, y]);
    };

    // Event handler for mouse move and touch move
    const draw = (event) => {
      if (!isDrawing) return;
      const { x, y } = getCoordinates(event);
      drawingData.push([x, y]);
      updateDrawing();
    };

    // Function to get the coordinates of the drawing based on the event type (mouse or touch)
    function getCoordinates(event) {
      let x, y;

      if (event.touches && event.touches.length > 0) {
        // Touch event
        const touch = event.touches[0];
        x = touch.clientX;
        y = touch.clientY;
      } else {
        // Mouse event
        x = event.clientX;
        y = event.clientY;
      }

      // Return the coordinates
      return { x, y };
    }

    // Event handler for mouse up and touch end
    const stopDrawing = () => {
      isDrawing = false;
      console.log(drawingData); // Extract values along the line here
      document.getElementById('saveButton').disabled = false;
      dataToSave = drawingData;
      drawingData = []; // Clear the drawing data for the next drawing
    };

    // Function to update the drawing on the SVG canvas
    const updateDrawing = () => {
      drawing.clear(); // Clear the previous drawing

      // Create a path string from the drawing data
      const pathString = drawingData.reduce((path, [x, y], index) => {
        if (index === 0) {
          return `M${x},${y}`;
        }
        return `${path} L${x},${y}`;
      }, '');

      // Draw the path on the SVG canvas
      drawing.path(pathString).fill('none').stroke('black');
    };

    const saveData = () => {
      document.getElementById('saveButton').disabled = true;
      // Convert the drawing data to JSON
      const jsonData = JSON.stringify(dataToSave, null, 2);

      // Create a new Blob object with the JSON data
      const blob = new Blob([jsonData], { type: 'application/json' });

      if (navigator.userAgent.match(/iPad/i) || navigator.userAgent.match(/iPhone/i)) {
        // For iPad or iPhone, use the file-sharing method
        const reader = new FileReader();
        reader.onload = function (event) {
          const url = event.target.result;

          const a = document.createElement('a');
          a.href = url;
          a.download = 'drawing_data.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
        reader.readAsDataURL(blob);
      } else {
        // For other devices, use the standard download method
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'drawing_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
      downloadSVG();
    };

    function downloadSVG() {
      const svgElement = document.getElementById('chartSvg');
      const svgCode = new XMLSerializer().serializeToString(svgElement);
      const blob = new Blob([svgCode], { type: 'image/svg+xml' });

      if (navigator.userAgent.match(/iPad/i) || navigator.userAgent.match(/iPhone/i)) {
        // For iPad or iPhone, use the file-sharing method
        const reader = new FileReader();
        reader.onload = function (event) {
          const url = event.target.result;

          const a = document.createElement('a');
          a.href = url;
          a.download = 'mySvg.svg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
        reader.readAsDataURL(blob);
      } else {
        // For other devices, use the standard download method
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'mySvg.svg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }

    // Attach event handlers to the SVG container
    const container = document.querySelector('#drawing-container');
    container.addEventListener('mousedown', startDrawing);
    container.addEventListener('mousemove', draw);
    container.addEventListener('mouseup', stopDrawing);

    // Touch events
    container.addEventListener('touchstart', startDrawing);
    container.addEventListener('touchmove', draw);
    container.addEventListener('touchend', stopDrawing);
  </script>
</body>

</html>